<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B1 Agent è§‚æµ‹å¹³å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">B1 Agent æ‰§è¡Œè§‚æµ‹å¹³å°</a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light" onclick="refreshRuns()">åˆ·æ–°</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>è¿è¡Œè®°å½•åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        <div id="runsList">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>è¯¦ç»†åˆ†æé¢æ¿</h5>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="debugInfo">
                            <div class="text-center text-muted">
                                <h6>ç‚¹å‡»å·¦ä¾§è¿è¡Œè®°å½•æŸ¥çœ‹åˆ†æ</h6>
                                <p>æ”¯æŒæ·±åº¦åˆ†æå’ŒåŸºç¡€ä¿¡æ¯æŸ¥çœ‹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let currentRuns = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            refreshRuns();
        });

        // åˆ·æ–°è¿è¡Œåˆ—è¡¨
        async function refreshRuns() {
            console.log('å¼€å§‹åˆ·æ–°è¿è¡Œåˆ—è¡¨...');
            const debugDiv = document.getElementById('debugInfo');
            const runsDiv = document.getElementById('runsList');
            
            try {
                debugDiv.innerHTML = 'æ­£åœ¨è·å–è¿è¡Œè®°å½•...';
                
                const response = await fetch('/runs');
                console.log('APIå“åº”çŠ¶æ€:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const runs = await response.json();
                console.log('è·å–åˆ°è¿è¡Œè®°å½•:', runs.length, runs);
                
                currentRuns = runs;
                renderRunsList(runs);
                
                debugDiv.innerHTML = `
                    <strong>è°ƒè¯•ä¿¡æ¯:</strong><br>
                    - APIçŠ¶æ€: ${response.status}<br>
                    - è®°å½•æ•°é‡: ${runs.length}<br>
                    - æœ€åæ›´æ–°: ${new Date().toLocaleTimeString()}
                `;
                
            } catch (error) {
                console.error('è·å–è¿è¡Œåˆ—è¡¨å¤±è´¥:', error);
                runsDiv.innerHTML = `<div class="alert alert-danger">è·å–å¤±è´¥: ${error.message}</div>`;
                debugDiv.innerHTML = `<div class="text-danger">é”™è¯¯: ${error.message}</div>`;
            }
        }

        // æ¸²æŸ“è¿è¡Œåˆ—è¡¨
        function renderRunsList(runs) {
            console.log('æ¸²æŸ“è¿è¡Œåˆ—è¡¨ï¼Œæ•°é‡:', runs.length);
            const container = document.getElementById('runsList');
            
            if (!container) {
                console.error('æ‰¾ä¸åˆ°runsListå®¹å™¨');
                return;
            }
            
            if (runs.length === 0) {
                container.innerHTML = '<div class="alert alert-info">æš‚æ— è¿è¡Œè®°å½•</div>';
                return;
            }
            
            let html = '';
            runs.forEach((run, index) => {
                const statusColor = run.status === 'done' ? 'success' : 
                                   run.status === 'running' ? 'primary' : 'danger';
                
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-3">
                            <h6 class="card-title">${run.run_id}</h6>
                            <p class="card-text small">${run.task || 'æ— ä»»åŠ¡æè¿°'}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-${statusColor}">${run.status}</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewRunDetails('${run.run_id}')">è¯¦ç»†åˆ†æ</button>
                                    <button class="btn btn-outline-info" onclick="viewSimpleDetails('${run.run_id}')">åŸºç¡€ä¿¡æ¯</button>
                                </div>
                            </div>
                            <small class="text-muted">${run.created_at}</small>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            console.log('è¿è¡Œåˆ—è¡¨æ¸²æŸ“å®Œæˆ');
        }

        // æŸ¥çœ‹è¿è¡Œè¯¦æƒ…
        async function viewRunDetails(runId) {
            console.log('æŸ¥çœ‹è¿è¡Œè¯¦æƒ…:', runId);
            const debugDiv = document.getElementById('debugInfo');
            
            try {
                debugDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> æ­£åœ¨åŠ è½½æ·±åº¦åˆ†æ...';
                
                // è·å–è¿è¡ŒåŸºç¡€æ•°æ®
                const runResponse = await fetch(`/runs/${runId}`);
                const runData = await runResponse.json();
                
                // è·å–æ·±åº¦åˆ†ææ•°æ®
                const analysisResponse = await fetch(`/runs/${runId}/analysis`);
                const analysisData = await analysisResponse.json();
                
                displayRunAnalysis(runData, analysisData);
                
            } catch (error) {
                console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);
                debugDiv.innerHTML = `<div class="alert alert-danger">è·å–è¯¦æƒ…å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æŸ¥çœ‹ç®€å•è¯¦æƒ…
        async function viewSimpleDetails(runId) {
            console.log('æŸ¥çœ‹ç®€å•è¯¦æƒ…:', runId);
            const debugDiv = document.getElementById('debugInfo');
            
            try {
                debugDiv.innerHTML = '<div class="spinner-border spinner-border-sm"></div> æ­£åœ¨åŠ è½½...';
                
                const response = await fetch(`/runs/${runId}`);
                const data = await response.json();
                
                displaySimpleDetails(data);
                
            } catch (error) {
                console.error('è·å–è¯¦æƒ…å¤±è´¥:', error);
                debugDiv.innerHTML = `<div class="alert alert-danger">è·å–è¯¦æƒ…å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºè¿è¡Œåˆ†æ
        function displayRunAnalysis(runData, analysisData) {
            const debugDiv = document.getElementById('debugInfo');
            const run = runData.run;
            const steps = runData.steps || [];
            
            let html = `
                <h5>æ·±åº¦åˆ†æ - ${run.run_id}</h5>
                <div class="mb-3">
                    <strong>ä»»åŠ¡:</strong> ${run.task}<br>
                    <strong>çŠ¶æ€:</strong> <span class="badge bg-${run.status === 'done' ? 'success' : 'primary'}">${run.status}</span><br>
                    <strong>æ­¥éª¤æ•°:</strong> ${steps.length}
                </div>
            `;
            
            if (analysisData.error) {
                html += `<div class="alert alert-warning">åˆ†æåŠŸèƒ½æš‚ä¸å¯ç”¨: ${analysisData.error}</div>`;
            } else {
                // æ€ç»´æ¨¡å¼åˆ†æ
                const pattern = analysisData.thinking_pattern || {};
                html += `
                    <div class="mb-3">
                        <h6>ğŸ§  æ€ç»´æ¨¡å¼åˆ†æ</h6>
                        <div class="row">
                            <div class="col-6">æ€è€ƒæ·±åº¦: <strong>${(pattern.depth_score * 100 || 0).toFixed(1)}%</strong></div>
                            <div class="col-6">é€»è¾‘è¿è´¯æ€§: <strong>${(pattern.coherence_score * 100 || 0).toFixed(1)}%</strong></div>
                            <div class="col-6">æ‰§è¡Œæ•ˆç‡: <strong>${(pattern.efficiency_score * 100 || 0).toFixed(1)}%</strong></div>
                            <div class="col-6">å†³ç­–è´¨é‡: <strong>${(pattern.decision_quality * 100 || 0).toFixed(1)}%</strong></div>
                        </div>
                    </div>
                `;
                
                // æ€§èƒ½æŒ‡æ ‡
                const perf = analysisData.performance_metrics || {};
                html += `
                    <div class="mb-3">
                        <h6>âš¡ æ€§èƒ½æŒ‡æ ‡</h6>
                        <div class="row">
                            <div class="col-6">æ€»Token: <strong>${perf.total_tokens || 0}</strong></div>
                            <div class="col-6">å¹³å‡å»¶è¿Ÿ: <strong>${(perf.avg_latency || 0).toFixed(3)}s</strong></div>
                            <div class="col-6">æˆåŠŸç‡: <strong>${((perf.success_rate || 0) * 100).toFixed(1)}%</strong></div>
                            <div class="col-6">é”™è¯¯æ•°: <strong>${perf.error_count || 0}</strong></div>
                        </div>
                    </div>
                `;
                
                // è´¨é‡è¯„ä¼°
                const quality = analysisData.quality_assessment || {};
                html += `
                    <div class="mb-3">
                        <h6>ğŸ“Š è´¨é‡è¯„ä¼°</h6>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: ${(quality.overall * 100 || 0)}%">
                                ç»¼åˆè¯„åˆ†: ${((quality.overall || 0) * 100).toFixed(1)}%
                            </div>
                        </div>
                        <small>å®Œæˆåº¦: ${((quality.completion || 0) * 100).toFixed(1)}% | 
                               æ•ˆç‡: ${((quality.efficiency || 0) * 100).toFixed(1)}% | 
                               ç¨³å®šæ€§: ${((quality.stability || 0) * 100).toFixed(1)}%</small>
                    </div>
                `;
                
                // å¼‚å¸¸æ£€æµ‹
                const anomalies = analysisData.anomaly_detection || [];
                if (anomalies.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6>âš ï¸ å¼‚å¸¸æ£€æµ‹</h6>
                            <div class="alert alert-warning">
                                <ul class="mb-0">
                                    ${anomalies.map(a => `<li>${a.description}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    html += `<div class="mb-3"><h6>âœ… å¼‚å¸¸æ£€æµ‹</h6><p class="text-success">æœªæ£€æµ‹åˆ°å¼‚å¸¸</p></div>`;
                }
                
                // æ”¹è¿›å»ºè®®
                const suggestions = analysisData.improvement_suggestions || [];
                if (suggestions.length > 0) {
                    html += `
                        <div class="mb-3">
                            <h6>ğŸ’¡ æ”¹è¿›å»ºè®®</h6>
                            <ul>
                                ${suggestions.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
            }
            
            // æ‰§è¡Œæ­¥éª¤
            html += `
                <div class="mb-3">
                    <h6>ğŸ“‹ æ‰§è¡Œæ­¥éª¤ (${steps.length})</h6>
                    <div style="max-height: 300px; overflow-y: auto;">
            `;
            
            steps.forEach((step, index) => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between">
                                <strong>Step ${step.step_no}</strong>
                                <small>${step.latency_s?.toFixed(3)}s</small>
                            </div>
                            ${step.thought ? `<div class="small text-primary">ğŸ’­ ${step.thought}</div>` : ''}
                            ${step.action ? `<div class="small text-success">ğŸ”§ ${step.action}</div>` : ''}
                            ${step.observation ? `<div class="small text-info">ğŸ‘ï¸ ${step.observation}</div>` : ''}
                            ${step.error ? `<div class="small text-danger">âŒ ${step.error}</div>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="refreshRuns()">è¿”å›åˆ—è¡¨</button>
            `;
            
            debugDiv.innerHTML = html;
        }

        // æ˜¾ç¤ºç®€å•è¯¦æƒ…
        function displaySimpleDetails(data) {
            const debugDiv = document.getElementById('debugInfo');
            const run = data.run;
            const steps = data.steps || [];
            
            const totalTokens = steps.reduce((sum, step) => {
                const usage = JSON.parse(step.model_usage_json || '{}');
                return sum + (usage.total_tokens || 0);
            }, 0);
            
            const totalLatency = steps.reduce((sum, step) => sum + (step.latency_s || 0), 0);
            
            debugDiv.innerHTML = `
                <h5>åŸºç¡€ä¿¡æ¯ - ${run.run_id}</h5>
                <div class="mb-3">
                    <strong>ä»»åŠ¡:</strong> ${run.task}<br>
                    <strong>çŠ¶æ€:</strong> <span class="badge bg-${run.status === 'done' ? 'success' : 'primary'}">${run.status}</span><br>
                    <strong>æ¨¡å‹:</strong> ${run.model}<br>
                    <strong>åˆ›å»ºæ—¶é—´:</strong> ${run.created_at}
                </div>
                <div class="mb-3">
                    <strong>ç»Ÿè®¡ä¿¡æ¯:</strong><br>
                    æ­¥éª¤æ•°: ${steps.length}<br>
                    æ€»è€—æ—¶: ${totalLatency.toFixed(2)}s<br>
                    Tokenæ¶ˆè€—: ${totalTokens}
                </div>
                ${run.final_answer ? `
                    <div class="mb-3">
                        <strong>æœ€ç»ˆç­”æ¡ˆ:</strong><br>
                        <div class="alert alert-info">${run.final_answer}</div>
                    </div>
                ` : ''}
                <button class="btn btn-secondary btn-sm" onclick="refreshRuns()">è¿”å›åˆ—è¡¨</button>
            `;
        }
    </script>
</body>
</html>
